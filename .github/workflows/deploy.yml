name: Build and Deploy Game Stats API

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Deployment secrets are stored in mosuon-devops-k8s repo and synced here on demand.
# The sync-secrets job checks which secrets are missing and only requests those.
# GH_PAT must exist in THIS repo to authenticate cross-repo workflow triggers.

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.sync.outputs.result }}
    steps:
      - name: Check and sync missing secrets
        id: sync
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REQUIRED_SECRETS="REGISTRY_USERNAME REGISTRY_PASSWORD REGISTRY_EMAIL GIT_TOKEN POSTGRES_PASSWORD REDIS_PASSWORD RABBITMQ_PASSWORD KUBE_CONFIG"

          echo "üîç Checking which deployment secrets exist..."
          EXISTING=$(gh secret list --repo "${{ github.repository }}" --json name -q '.[].name' 2>/dev/null || echo "")

          MISSING=()
          for secret in $REQUIRED_SECRETS; do
            if echo "$EXISTING" | grep -qx "$secret"; then
              echo "  ‚úÖ $secret"
            else
              echo "  ‚ùå $secret ‚Äî missing"
              MISSING+=("$secret")
            fi
          done

          echo ""
          if [ ${#MISSING[@]} -eq 0 ]; then
            echo "‚úÖ All secrets already exist ‚Äî skipping sync"
            echo "result=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          MISSING_LIST="${MISSING[*]}"
          echo "üìä ${#MISSING[@]} secret(s) need syncing: $MISSING_LIST"
          echo ""

          # Trigger mosuon-devops-k8s sync for ONLY the missing secrets
          echo "üîÑ Triggering mosuon-devops-k8s/sync-secrets.yml..."
          gh workflow run sync-secrets.yml \
            --repo Bengo-Hub/mosuon-devops-k8s \
            --ref master \
            -f target_repo="${{ github.repository }}" \
            -f secrets="$MISSING_LIST"

          # Wait for the missing secrets to appear (max 3 min)
          echo "‚è≥ Waiting for secrets to be synced..."
          for i in $(seq 1 18); do
            sleep 10
            CURRENT=$(gh secret list --repo "${{ github.repository }}" --json name -q '.[].name' 2>/dev/null || echo "")
            STILL_MISSING=0
            for secret in "${MISSING[@]}"; do
              echo "$CURRENT" | grep -qx "$secret" || STILL_MISSING=$((STILL_MISSING + 1))
            done
            if [ $STILL_MISSING -eq 0 ]; then
              echo "‚úÖ All ${#MISSING[@]} secrets synced after $((i * 10))s"
              echo "result=synced" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "  ‚è≥ ${STILL_MISSING} still missing ($((i * 10))s)..."
          done

          echo "‚ö†Ô∏è Timeout ‚Äî some secrets may not have synced"
          echo "result=partial" >> $GITHUB_OUTPUT

  deploy:
    needs: sync-secrets
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install DevOps Tools
        uses: Bengo-Hub/mosuon-devops-k8s/.github/actions/install-devops-tools@main

      - name: Set deployment variables
        run: |
          echo "DEPLOY=true" >> $GITHUB_ENV
          echo "SETUP_DATABASES=true" >> $GITHUB_ENV
          echo "DB_TYPES=postgres,redis" >> $GITHUB_ENV
          echo "NAMESPACE=mosuon" >> $GITHUB_ENV
          echo "ENV_SECRET_NAME=game-stats-api-secrets" >> $GITHUB_ENV
          echo "REGISTRY_SERVER=docker.io" >> $GITHUB_ENV
          echo "REGISTRY_NAMESPACE=codevertex" >> $GITHUB_ENV
          echo "VALUES_FILE_PATH=apps/game-stats-api/values.yaml" >> $GITHUB_ENV
          echo "APP_NAME=game-stats-api" >> $GITHUB_ENV
          echo "DEVOPS_REPO=Bengo-Hub/mosuon-devops-k8s" >> $GITHUB_ENV

      - name: Verify secrets
        run: |
          echo "Verifying deployment secrets..."
          echo "Sync result: ${{ needs.sync-secrets.outputs.result }}"
          echo ""
          FAIL=0

          check_secret() {
            local name="$1" min_len="$2" value="$3"
            if [[ -z "$value" ]]; then
              echo "‚ùå $name ‚Äî empty"
              FAIL=1
            elif [[ ${#value} -lt $min_len ]]; then
              echo "‚ö†Ô∏è  $name ‚Äî ${#value} chars (need >=$min_len)"
              FAIL=1
            else
              echo "‚úÖ $name (${#value} chars)"
            fi
          }

          check_secret "REGISTRY_USERNAME"  5    "$REGISTRY_USERNAME"
          check_secret "REGISTRY_PASSWORD"  20   "$REGISTRY_PASSWORD"
          check_secret "KUBE_CONFIG"        1000 "$KUBE_CONFIG"
          check_secret "GIT_TOKEN"          20   "$GIT_TOKEN"
          check_secret "POSTGRES_PASSWORD"  8    "$POSTGRES_PASSWORD"
          check_secret "REDIS_PASSWORD"     8    "$REDIS_PASSWORD"

          if [[ $FAIL -eq 1 ]]; then
            echo ""
            echo "‚ùå Secret verification failed!"
            echo ""
            echo "Possible causes:"
            echo "  1. Secrets were just synced in this workflow run."
            echo "     GitHub loads secrets when each job STARTS."
            echo "     If sync-secrets just created them, re-run this workflow."
            echo ""
            echo "  2. mosuon-devops-k8s PROPAGATE_PAT may lack write access."
            echo "     Check: https://github.com/Bengo-Hub/mosuon-devops-k8s/actions"
            echo ""
            echo "  3. Corrupted repo-level secret overriding correct value."
            echo "     Fix: delete the bad secret, then re-run:"
            echo "     gh secret delete <NAME> --repo ${{ github.repository }}"
            exit 1
          fi

          echo ""
          echo "‚úÖ All secrets verified"
        env:
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

      - name: Run production deployment
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
          GH_PAT: ${{ secrets.GH_PAT }}
          GIT_SECRET: ${{ secrets.GIT_SECRET }}
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GITHUB_SHA: ${{ github.sha }}
          DEPLOY: true
          SETUP_DATABASES: true
          DB_TYPES: postgres,redis
          NAMESPACE: mosuon
          ENV_SECRET_NAME: game-stats-api-secrets
          REGISTRY_SERVER: docker.io
          REGISTRY_NAMESPACE: codevertex
          VALUES_FILE_PATH: apps/game-stats-api/values.yaml
          APP_NAME: game-stats-api
          DEVOPS_REPO: Bengo-Hub/mosuon-devops-k8s
          GIT_USER: ${{ secrets.GIT_USER || 'Game Stats Bot' }}
          GIT_EMAIL: ${{ secrets.GIT_EMAIL || 'dev@ultimatestats.co.ke' }}
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Tag and push :latest
        if: success()
        env:
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          REGISTRY_SERVER: docker.io
          REGISTRY_NAMESPACE: codevertex
        run: |
          set -e
          IMAGE_REPO="${REGISTRY_SERVER}/${REGISTRY_NAMESPACE}/game-stats-api"
          SHORT_SHA=${GITHUB_SHA::8}
          echo "Tagging ${IMAGE_REPO}:${SHORT_SHA} as :latest"
          echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY_SERVER" -u "$REGISTRY_USERNAME" --password-stdin
          docker pull "${IMAGE_REPO}:${SHORT_SHA}" || true
          docker tag "${IMAGE_REPO}:${SHORT_SHA}" "${IMAGE_REPO}:latest"
          docker push "${IMAGE_REPO}:latest"

      - name: Check ArgoCD Application status
        if: success()
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG }}
          NS: mosuon
          APP_NAME: game-stats-api
        run: |
          if [ -z "${KUBE_CONFIG_B64}" ]; then
            echo "‚è≠Ô∏è Skipping ArgoCD check - no KUBE_CONFIG available"
            exit 0
          fi

          echo "::group::ArgoCD Application Status"
          mkdir -p ~/.kube
          echo "$KUBE_CONFIG_B64" | base64 -d > ~/.kube/config

          if kubectl get application ${APP_NAME} -n argocd >/dev/null 2>&1; then
            echo "‚úì ArgoCD Application '${APP_NAME}' found"
            kubectl patch application ${APP_NAME} -n argocd --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' || true
            SYNC_STATUS=$(kubectl get application ${APP_NAME} -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            HEALTH_STATUS=$(kubectl get application ${APP_NAME} -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
            echo "Current Status - Sync: ${SYNC_STATUS}, Health: ${HEALTH_STATUS}"
          else
            echo "‚ö†Ô∏è ArgoCD Application '${APP_NAME}' not found"
            echo "Trigger provisioning: gh workflow run provision.yml --repo Bengo-Hub/mosuon-devops-k8s"
          fi
          echo "::endgroup::"

      - name: Verify API health
        if: success()
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG }}
          NS: mosuon
        run: |
          if [ -z "${KUBE_CONFIG_B64}" ]; then
            echo "‚è≠Ô∏è Skipping health check - no KUBE_CONFIG available"
            exit 0
          fi

          echo "::group::Health check"
          mkdir -p ~/.kube
          echo "$KUBE_CONFIG_B64" | base64 -d > ~/.kube/config

          if kubectl get deployment game-stats-api -n ${NS} >/dev/null 2>&1; then
            kubectl rollout status deployment/game-stats-api -n ${NS} --timeout=1200s
            HOSTS=$(kubectl get ingress -n ${NS} -o jsonpath='{.items[*].spec.rules[*].host}' | tr ' ' '\n' | grep -E 'stats|api' || true)
            if [ -n "$HOSTS" ]; then
              for H in $HOSTS; do
                echo "Checking https://$H/health ..."
                if curl -sk --max-time 10 "https://$H/health" | grep -qi "healthy"; then
                  echo "‚úÖ Health OK for $H"
                  break
                fi
              done
            else
              echo "No ingress host found; skipping external health probe"
            fi
          else
            echo "Deployment not found yet - ArgoCD may still be syncing"
          fi
          echo "::endgroup::"
